# ะญะบัััะฐะฟะพะปััะธั ะดะธะฐะผะตััะฐ ะฟััะบะฐ ะทะฐ ะฟัะตะดะตะปั ะบะฐะปะธะฑัะพะฒะบะธ

## ะะฑะทะพั

ะะพะณะดะฐ ะทะฐะฟัะฐัะธะฒะฐะตะผัะน ะดะธะฐะผะตัั **ะฑะพะปััะต ะผะฐะบัะธะผะฐะปัะฝะพะณะพ ะธะทะผะตัะตะฝะฝะพะณะพ** (95.4 ฮผm), ัะธััะตะผะฐ ะฐะฒัะพะผะฐัะธัะตัะบะธ ะธัะฟะพะปัะทัะตั **ะปะธะฝะตะนะฝัั ัะบัััะฐะฟะพะปััะธั** ะฝะฐ ะพัะฝะพะฒะต ะฟะพัะปะตะดะฝะธั ะดะฒัั ัะพัะตะบ ะบะฐะปะธะฑัะพะฒะบะธ.

## ะะฐะบ ััะพ ัะฐะฑะพัะฐะตั

### ะะฐะปะธะฑัะพะฒะพัะฝัะน ะดะธะฐะฟะฐะทะพะฝ:
- **ะะธะฝะธะผะฐะปัะฝัะน ะดะธะฐะผะตัั:** 49.09 ฮผm @ Z = 0.03 mm (ัะพะบัั)
- **ะะฐะบัะธะผะฐะปัะฝัะน ะดะธะฐะผะตัั:** 95.40 ฮผm @ Z = -0.10 mm

### ะญะบัััะฐะฟะพะปััะธั ะดะปั ะฑะพะปััะธั ะดะธะฐะผะตััะพะฒ (> 95.4 ฮผm):

**ะะะะะ:** ะัะฟะพะปัะทััััั **ะฟะตัะฒัะต ะดะฒะต ัะพัะบะธ** ะฝะฐ **ะะขะะะฆะะขะะะฌะะะ ััะพัะพะฝะต** ะพั ัะพะบััะฐ, ะณะดะต ะดะธะฐะผะตััั ะฑะพะปััะต:
- **ะขะพัะบะฐ 1:** 95.40 ฮผm @ Z = -0.10 mm (ะผะฐะบัะธะผะฐะปัะฝัะน ะธะทะผะตัะตะฝะฝัะน ะดะธะฐะผะตัั)
- **ะขะพัะบะฐ 2:** 93.00 ฮผm @ Z = -0.09 mm

**ะะพัะตะผั ะพััะธัะฐัะตะปัะฝะฐั ััะพัะพะฝะฐ?**
- ะะพะปะพะถะธัะตะปัะฝะฐั ััะพัะพะฝะฐ (Z > 0.03): ะดะธะฐะผะตััั ะพั 49.09 ะดะพ 63.52 ฮผm (ัะทะบะธะน ะดะธะฐะฟะฐะทะพะฝ)
- **ะััะธัะฐัะตะปัะฝะฐั ััะพัะพะฝะฐ (Z < 0.03): ะดะธะฐะผะตััั ะพั 49.09 ะดะพ 95.40 ฮผm (ัะธัะพะบะธะน ะดะธะฐะฟะฐะทะพะฝ)** โ

**ะคะพัะผัะปะฐ:**
```
slope = (Dโ - Dโ) / (Zโ - Zโ)
slope = (93.00 - 95.40) / (-0.09 - (-0.10)) = -2.40 / 0.01 = -240 ฮผm/mm

Z_extrapolated = Zโ + (D_target - Dโ) / slope
```

**ะัะธะผะตั ะดะปั 100 ฮผm:**
```
Z = -0.10 + (100 - 95.40) / (-240)
Z = -0.10 + 4.60 / (-240)
Z = -0.10 - 0.019
Z = -0.119 mm
```

## ะขะฐะฑะปะธัะฐ ะทะฝะฐัะตะฝะธะน (ั ะธัะฟะพะปัะทะพะฒะฐะฝะธะตะผ ะะขะะะฆะะขะะะฌะะะ ััะพัะพะฝั):

| ะฆะตะปะตะฒะพะน ะดะธะฐะผะตัั (ฮผm) | Z (mm)     | ะขะธะฟ |
|----------------------|------------|-----|
| 70                   | -0.051     | ะะฝัะตัะฟะพะปััะธั โ (ะพััะธัะฐัะตะปัะฝะฐั ััะพัะพะฝะฐ) |
| 80                   | -0.075     | ะะฝัะตัะฟะพะปััะธั โ (ะพััะธัะฐัะตะปัะฝะฐั ััะพัะพะฝะฐ) |
| 90                   | -0.089     | ะะฝัะตัะฟะพะปััะธั โ (ะพััะธัะฐัะตะปัะฝะฐั ััะพัะพะฝะฐ) |
| **100**              | **-0.119** | **ะญะบัััะฐะฟะพะปััะธั** โ๏ธ (ะพััะธัะฐัะตะปัะฝะฐั ััะพัะพะฝะฐ) |
| **120**              | **-0.202** | **ะญะบัััะฐะฟะพะปััะธั** โ๏ธ (ะพััะธัะฐัะตะปัะฝะฐั ััะพัะพะฝะฐ) |
| **150**              | **-0.328** | **ะญะบัััะฐะฟะพะปััะธั** โ๏ธ (ะพััะธัะฐัะตะปัะฝะฐั ััะพัะพะฝะฐ) |

**ะัะธะผะตัะฐะฝะธะต:** ะัะต ะทะฝะฐัะตะฝะธั ะดะปั ะดะธะฐะผะตััะพะฒ > 63.52 ฮผm ัะตะฟะตัั ะธัะฟะพะปัะทััั ะพััะธัะฐัะตะปัะฝัั ััะพัะพะฝั (Z < 0.03), ะณะดะต ะดะธะฐะฟะฐะทะพะฝ ะบะฐะปะธะฑัะพะฒะบะธ ัะธัะต.

## ะัะตะดัะฟัะตะถะดะตะฝะธั

### โ๏ธ ะะฐะถะฝะพ:

1. **ะะธะฝะตะนะฝะฐั ัะบัััะฐะฟะพะปััะธั - ััะพ ะฟัะธะฑะปะธะถะตะฝะธะต!**
   - ะะตะฐะปัะฝะฐั ะทะฐะฒะธัะธะผะพััั ะผะพะถะตั ะฑััั ะฝะตะปะธะฝะตะนะฝะพะน ะฒะฝะต ะดะธะฐะฟะฐะทะพะฝะฐ ะธะทะผะตัะตะฝะธะน
   - ะขะพัะฝะพััั ัะฝะธะถะฐะตััั ั ัะฒะตะปะธัะตะฝะธะตะผ ัะฐัััะพัะฝะธั ะพั ะฟะพัะปะตะดะฝะตะน ะธะทะผะตัะตะฝะฝะพะน ัะพัะบะธ

2. **ะะตะบะพะผะตะฝะดัะตััั:**
   - ะะปั ะดะธะฐะผะตััะพะฒ > 100 ฮผm: **ะฟัะพะฒะตัะธัั ัะตะฐะปัะฝัะน ะดะธะฐะผะตัั** ะฝะฐ ะพะฑะพััะดะพะฒะฐะฝะธะธ
   - ะัะปะธ ััะตะฑัะตััั ะฒััะพะบะฐั ัะพัะฝะพััั: **ัะฐััะธัะธัั ะบะฐะปะธะฑัะพะฒะพัะฝัั ัะฐะฑะปะธัั**

3. **ะะพะฝัะพะปัะฝัะน ะฒัะฒะพะด:**
   ```
   โ๏ธ EXTRAPOLATION: Diameter 100.00 ฮผm > max measured 95.40 ฮผm
      Using linear extrapolation from last 2 points:
      (58.45 ฮผm @ 0.090 mm) โ (63.52 ฮผm @ 0.100 mm)
      Extrapolated Z = 0.172 mm (USE WITH CAUTION!)
   ```

## ะะพะด

### ะัะฟะพะปัะทะพะฒะฐะฝะธะต:

```csharp
try
{
    // ะะฒัะพะผะฐัะธัะตัะบะธ ะธัะฟะพะปัะทัะตั ัะบัััะฐะฟะพะปััะธั ะตัะปะธ ะฝัะถะฝะพ
    double z = BeamDiameterCalibration.CalculateZForDiameter(100.0);
    Console.WriteLine($"Z for 100 ฮผm: {z:F3} mm");
    // Output: Z for 100 ฮผm: 0.172 mm
    // + ะฟัะตะดัะฟัะตะถะดะตะฝะธะต ะพะฑ ัะบัััะฐะฟะพะปััะธะธ
}
catch (ArgumentOutOfRangeException ex)
{
    // ะขะพะปัะบะพ ะดะปั ะดะธะฐะผะตััะพะฒ < 49.09 ฮผm
    Console.WriteLine($"Cannot achieve: {ex.Message}");
}
```

### Fallback ะฒ TestUdmBuilder:

ะัะปะธ ัะบัััะฐะฟะพะปััะธั ะฝะต ัะดะฐัััั, ะฐะฒัะพะผะฐัะธัะตัะบะธ ะธัะฟะพะปัะทัะตััั ัะตะพัะตัะธัะตัะบะธะน ัะฐัััั:

```csharp
// ะ TestUdmBuilder.cs:
try
{
    double zFromCalibration = BeamDiameterCalibration.CalculateZForDiameter(beamDiameterMicron);
    zOffsetMm = (float)zFromCalibration;
    // ะะพะถะตั ะธัะฟะพะปัะทะพะฒะฐัั ัะบัััะฐะฟะพะปััะธั
}
catch (ArgumentOutOfRangeException ex)
{
    // Fallback ะฝะฐ ัะตะพัะตัะธัะตัะบะธะน ัะฐัััั (ะะฐัััะพะฒะฐ ัะพัะผัะปะฐ)
    zOffsetMm = _config.BeamConfig.CalculateZOffset(beamDiameterMicron);
}
```

## ะะฐััะธัะตะฝะธะต ะบะฐะปะธะฑัะพะฒะบะธ

### ะะฐะบ ะดะพะฑะฐะฒะธัั ะธะทะผะตัะตะฝะธั ะดะปั ะฑะพะปััะธั ะดะธะฐะผะตััะพะฒ:

1. **ะะทะผะตัะธัั ัะตะฐะปัะฝัะต ะดะธะฐะผะตััั** ะฟัะธ Z = 0.11, 0.12, 0.13, ... mm

2. **ะะฑะฝะพะฒะธัั CalibrationTable** ะฒ `BeamDiameterCalibration.cs`:
   ```csharp
   private static readonly List<(double Z, double Diameter)> CalibrationTable = new()
   {
       // ... ัััะตััะฒัััะธะต ัะพัะบะธ ...
       (0.10, 63.52),
       (0.11, 68.20),  // ะะะะะ ะธะทะผะตัะตะฝะธะต
       (0.12, 73.15),  // ะะะะะ ะธะทะผะตัะตะฝะธะต
       (0.15, 85.40),  // ะะะะะ ะธะทะผะตัะตะฝะธะต
       // ะธ ั.ะด.
   };
   ```

3. **ะะตัะตัะพะฑัะฐัั ะฟัะพะตะบั** - ัะบัััะฐะฟะพะปััะธั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฑัะดะตั ะธัะฟะพะปัะทะพะฒะฐัั ะฝะพะฒัะต ะณัะฐะฝะธัั

## ะะปััะตัะฝะฐัะธะฒั

### 1. ะะฒะฐะดัะฐัะธัะฝะฐั ะธะฝัะตัะฟะพะปััะธั

ะะผะตััะพ ะปะธะฝะตะนะฝะพะน ะผะพะถะฝะพ ะธัะฟะพะปัะทะพะฒะฐัั ะฟะฐัะฐะฑะพะปะธัะตัะบัั ะฐะฟะฟัะพะบัะธะผะฐัะธั:
```csharp
// ะะผะตััะพ 2 ัะพัะตะบ ะธัะฟะพะปัะทัะตะผ 3 ะฟะพัะปะตะดะฝะธะต
// ะกััะพะธะผ ะฟะฐัะฐะฑะพะปั: d = a*Zยฒ + b*Z + c
```

**ะัะตะธะผััะตััะฒะฐ:** ะัััะต ััะธััะฒะฐะตั ะบัะธะฒะธะทะฝั
**ะะตะดะพััะฐัะบะธ:** ะกะปะพะถะฝะตะต, ะผะพะถะตั ะดะฐะฒะฐัั ะฝะตััะฐะฑะธะปัะฝัะต ัะตะทัะปััะฐัั

### 2. ะขะตะพัะตัะธัะตัะบะธะน ัะฐัััั (ะะฐัััะพะฒ ะฟััะพะบ)

ะัะฟะพะปัะทัะตััั ะบะฐะบ fallback:
```csharp
z = z_R ร sqrt[(d/dโ)ยฒ - 1]
```

**ะัะตะธะผััะตััะฒะฐ:** ะะฐะฑะพัะฐะตั ะดะปั ะปัะฑัั ะดะธะฐะผะตััะพะฒ
**ะะตะดะพััะฐัะบะธ:** ะะต ััะธััะฒะฐะตั ัะตะฐะปัะฝัะต ะพัะพะฑะตะฝะฝะพััะธ ะพะฟัะธะบะธ

### 3. ะะพะฑะฐะฒะธัั ะฑะพะปััะต ะธะทะผะตัะตะฝะธะน

**ะะตะบะพะผะตะฝะดัะตััั!** ะกะฐะผัะน ะฝะฐะดัะถะฝัะน ัะฟะพัะพะฑ:
- ะะทะผะตัะธัั ะดะธะฐะผะตััั ะฟัะธ Z = 0.11, 0.12, 0.15, 0.20 mm
- ะะพะบัััั ะฒะตัั ัะฐะฑะพัะธะน ะดะธะฐะฟะฐะทะพะฝ ะดะธะฐะผะตััะพะฒ

## ะขะตััะธัะพะฒะฐะฝะธะต

ะะฐะฟัััะธัะต ัะตััั ะดะปั ะฟัะพะฒะตัะบะธ ัะบัััะฐะฟะพะปััะธะธ:

```csharp
BeamDiameterCalibrationTest.RunAllTests();
```

**ะะถะธะดะฐะตะผัะน ะฒัะฒะพะด:**
```
TEST 3: Diameter โ Z Conversion (including extrapolation)
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โโโโโโโโโโโโโโโโฌโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโ
โ Diameter(ฮผm) โ Z (mm)   โ Status           โ
โโโโโโโโโโโโโโโโผโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโค
โ        65.00 โ    0.043 โ โ Interpolated   โ
โ        80.00 โ    0.076 โ โ Interpolated   โ
โ       100.00 โ    0.172 โ โ Extrapolated   โ
โ       120.00 โ    0.212 โ โ Extrapolated   โ
โ       150.00 โ    0.271 โ โ Extrapolated   โ
โโโโโโโโโโโโโโโโดโโโโโโโโโโโดโโโโโโโโโโโโโโโโโโโ
```

## ะัะฒะพะดั

โ **ะญะบัััะฐะฟะพะปััะธั ัะฐะฑะพัะฐะตั** ะดะปั ะดะธะฐะผะตััะพะฒ ะดะพ ~150-200 ฮผm
โ๏ธ **ะัะฟะพะปัะทัะนัะต ั ะพััะพัะพะถะฝะพัััั** - ะฟัะพะฒะตััะนัะต ัะตะฐะปัะฝัะต ัะตะทัะปััะฐัั
๐ **ะัััะตะต ัะตัะตะฝะธะต** - ัะฐััะธัะธัั ะบะฐะปะธะฑัะพะฒะพัะฝัั ัะฐะฑะปะธัั ัะตะฐะปัะฝัะผะธ ะธะทะผะตัะตะฝะธัะผะธ

---

**ะะฐัะฐ:** 2025-01-20
**ะะตััะธั:** 2.1
